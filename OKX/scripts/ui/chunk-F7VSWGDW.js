import{a as y}from"./chunk-QZO7W5WD.js";import{b as z,c as Q}from"./chunk-RI2WZ5PA.js";import{a as le,c as ue}from"./chunk-Q4YTGP2G.js";import{b as de,c as me}from"./chunk-B3JSNQIV.js";import{Cb as T,Ha as ce,h as oe}from"./chunk-HPWCPLRR.js";import{k as ee,l as ze}from"./chunk-3DZ7WRLL.js";import{d as E,f as W}from"./chunk-DEOJU4Z3.js";import{c as _}from"./chunk-N2BCRNDB.js";import{$c as ie,I as w,Ia as M,Ic as ne,Jc as re,K as I,L as J,Na as Z,Sc as se,Zc as ae,_c as Xe,a as H,b as $e,ha as $,pc as te,rc as Qe,rd as Ze,ya as B,za as X}from"./chunk-TM67VPZU.js";import{f as Y,m as L,n as x,ra as K,x as S,y as b}from"./chunk-XDY6V34Y.js";import{o as u,q as d}from"./chunk-6KXF36WM.js";u();d();K();W();X();u();d();async function q(e){return!Array.isArray(e)||e.length===0?!1:(await _.assets).set(e)}u();d();async function fe(e){return!Array.isArray(e)||e.length===0?!1:(await _.balance).set(e,{clear:!0})}async function ge(e){try{return await(await _.balance).get(e)}catch{return null}}async function pe(){try{return await(await _.balance).getAll()}catch{return null}}Z();u();d();var F=(o=>(o.ERR_NETWORK="ERR_NETWORK",o.ERR_SERVER_LIMIT="ERR_SERVER_LIMIT",o.ERR_SERVER_TINE_LIMIT="ERR_SERVER_TINE_LIMIT",o.ERR_SERVER_COMMON="ERR_SERVER_COMMON",o.ERR_DEFAULT="ERR_DEFAULT",o))(F||{}),Ie=(e,t)=>{if(e?.status&&e.status==="ERR_NETWORK")throw new y("ERR_NETWORK","ERR_NETWORK");if(e?.status&&e.status===429)throw new y("ERR_SERVER_LIMIT","ERR_SERVER_LIMIT");if(e?.status&&e.status===400&&e.data?.code===50113)throw new y("ERR_SERVER_TINE_LIMIT","ERR_SERVER_TINE_LIMIT");if(e?.status&&e.status!==200)throw new y(e?.data?.error_message||e?.data?.msg,"ERR_SERVER_COMMON");if(e?.code!==0&&(e?.error_message||e?.msg))throw new y(e?.error_message||e?.msg,"ERR_SERVER_COMMON");if(t)throw new y(e?.message,"ERR_DEFAULT")},pt=e=>e?.status&&e.status==="ERR_NETWORK"?"ERR_NETWORK":e?.status&&e.status===429?"ERR_SERVER_LIMIT":e?.status&&e.status===400&&e.data?.code===50113?"ERR_SERVER_TINE_LIMIT":e?.status&&e.status!==200||e?.code!==0&&e.status===200&&(e?.error_message||e?.msg)?e?.data?.error_message??e?.data?.msg??"ERR_SERVER_COMMON":"";u();d();K();W();X();Z();u();d();ze();$e();var et=ee({name:"balanceSlice",initialState:{balanceMap:{}},reducers:{setBalance:(e,t)=>{e.balanceMap=t.payload}}}),{actions:Ae,reducer:tt}=et;function nt(e){H.captureEvent({message:"STORE_WARN_indexeddb_error",exception:{values:[{type:"STORE_WARN_indexeddb_error",value:e}]},level:"error"})}var ht=()=>async e=>{let t=await pe();if(!t||t.filter?.(s=>!s).length>0){nt(`subscribe balance null, ${JSON.stringify(t)}`);return}let r=t.reduce((s,n)=>(s[n.walletId]=n,s),{});e(Ae.setBalance(r))},{setBalance:Ee}=Ae,St=tt;u();d();u();d();K();$();function Re({balanceCoins:e,coinsMap:t,flatten:r=!1}){let s=[];return e.forEach(n=>{if(n.childrenCoin){let o=n.childrenCoin.map(a=>({...a,...t.get(a.coinId)}));r?s.push(...o):s.push({...n,...t.get(n.coinId),childrenCoin:o})}else s.push({...n,childrenCoin:void 0,...t.get(n.coinId)})}),s}var Ce=(e,t)=>{let r=e.coinBalanceDetails.map(s=>t.address===s.userAddress&&s.coinId===t.coinId?{...s,coinAmount:String(t.coinAmountOriginalDec),coinAmountOrigin:String(t.coinAmount),currencyAmount:String(t.currencyAmount)}:s);return{...e,coinBalanceDetails:r,coinAmount:r.reduce((s,n)=>I(s,n.coinAmount),"0"),coinAmountOrigin:r.reduce((s,n)=>I(s,n.coinAmountOrigin),"0"),currencyAmount:r.reduce((s,n)=>I(s,n.currencyAmount),"0"),symbol:t.symbol,name:t.name,imageUrl:t.logo}};async function ye({pushData:e,store:t,walletId:r,account:s}){let n=x(t),o=S(t.data.assets,i=>i.walletId===r),a=S(t.data.assets[o].tokens,i=>b(i.coinBalanceDetails,l=>l.coinId===e.coinId));if(a===-1){let i=await ce(e.subBalanceType===1?{aggregationSymbol:e.symbol}:{coinId:e.coinId},e,r,s);if(!i)return!1;n.data.coins.push(...i.coins);let c=t.data.assets[o].tokens.length;n.data.assets[o].tokens[c]=Ce(i.token,e)}else n.data.assets[o].tokens[a]=Ce(t.data.assets[o].tokens[a],e);return n}function he({pushData:e,store:t}){let r=x(t),s=t.data.assets[0].nfts,{receive:n,reduce:o}=e,a=(n||o)?.collectionItem.chainId,i=S(s,c=>b(c.networkValuations,l=>l.chainId===a));return i===-1?n&&r.data.assets[0].nfts.push({networkValuations:[{chainId:a,name:n.collectionItem.name,valuation:w(n.count,n.collectionItem.floorSalePrice?.usdPrice??0)}]}):r.data.assets[0].nfts[i]={...t.data.assets[0].nfts[i],networkValuations:t.data.assets[0].nfts[i].networkValuations.map(c=>({...c,valuation:n?I(c.valuation,w(n.count,n.collectionItem.floorSalePrice?.usdPrice??0)):o&&J(c.valuation,w(o.count,o.collectionItem.floorSalePrice?.usdPrice??0))}))},r}function Se({pushData:e,store:t,walletId:r}){let s=x(t),n=S(t.data.assets,a=>a.walletId===r),o=S(t.data.assets[n].defis,a=>a.chainId===e.chainId&&a.platformId===e.analysisPlatformId);if(o!==-1){let{platform:a,network:i,url:c,web:l,logo:m,balance:g}=e;s.data.assets[n].defis[o]={...t.data.assets[n].defis[o],defiUrl:c,logo:m,platform:a,balance:g,web:l,network:i}}else s.data.assets[n].defis.push({accountId:r,balance:e.balance,chainId:e.chainId,chainName:e?.chainName,defiUrl:e.url,logo:e.logo,network:e.network,platform:e.platform,platformId:e.analysisPlatformId,walletId:r,web:e.web});return s.data.coins=t.data.coins.map(a=>!a.voucherToken&&b(e.lpTokenAddressList,i=>a.address?i.tokenAddress===a.address:i.chainId===a.chainId)?{...a,voucherToken:!0}:a),s}u();d();var we={};function k(){return we}function _e(e){we=e}async function Te({data:e,channel:t,walletId:r,account:s}){try{return t==="wallet-asset"?await ye({pushData:e,store:k(),walletId:r,account:s}):t==="invest-DeFi"?Se({pushData:e?.data||e,store:k(),walletId:r}):he({pushData:e,store:k(),walletId:r})}catch{return!1}}u();d();$();function xe(e){let t=e.reduce((r,s)=>{let{chainId:n,currencyAmountUSD:o}=s;return r.has(n)?r.set(n,I(r.get(n),o)):r.set(n,o),r},new Map);return Array.from(t).map(([r,s])=>({chainId:r,currencyAmountUSD:s}))}function rt(e,t,r){let{coinAmount:s,currencyAmount:n,coinAmountOrigin:o,...a}=e,i=t.get(e.coinId),c=r?.[e.coinId]?.coinToUSDRate;return{...a,coinAmount:s,coinAmountInt:o,currencyAmountUSD:c?w(s,c):n,baseCoinId:i.baseCoinId}}function be(e,t,r){return e.map(n=>{let{defis:o,nfts:a,tokens:i,accountId:c}=n,l=i?.map(f=>{let{coinAmountOrigin:A,coinBalanceDetails:h,currencyAmount:v,subBalanceType:R,imageUrl:Ge,...He}=f,D=h.map(V=>rt(V,t,r)),Ye=D[0],j=R===1,G=R===2;return{...Ye,...He,image:Ge,currencyAmountUSD:D.reduce((V,Je)=>I(V,Je.currencyAmountUSD),"0"),coinAmountInt:A,aggregation:j,isAddressAggregation:G,childrenCoin:j||G?D:void 0}})??null,m=o?.map(f=>({currencyAmountUSD:f.balance,chainId:f.chainId}))??null,g=a?.reduce((f,A)=>f.concat(A.networkValuations||[]),[]).map(f=>({chainId:f.chainId,currencyAmountUSD:f.valuation}))??null;return{defi:m?xe(m):null,nft:g?xe(g):null,coins:l,walletId:c,v:2}})}function We(e,t){let{coins:r,balanceData:s,walletId:n}=e,o=s?.coins??[],a=[];return o.forEach(i=>{if(i.childrenCoin){let c=[];i.childrenCoin.forEach(l=>{l.coinId===+t&&c.push(l)}),c.length>0&&(Object.assign(i,{...c[0],childrenCoin:c}),i.coinAmountInt=c.reduce((l,m)=>I(l,m.coinAmountInt),"0"),i.coinAmount=c.reduce((l,m)=>I(l,m.coinAmount),"0"),i.currencyAmountUSD=c.reduce((l,m)=>I(l,m.currencyAmountUSD),"0"),a.push(i))}else i.coinId===+t&&a.push(i)}),{walletId:n,balanceCoins:a,coins:r.filter(i=>i.coinId===+t)}}u();d();W();var st="usd";function C(e){return e?.keyring?.selectedWallet}function Be(e,t){let{createdMap:r}=e.metamask;return Boolean(r[t])}function Me(e){let{createdMap:t}=e.metamask;return Object.keys(t??{})}function O(e){return e.metamask.selectedCurrency?.isoCode||st}function U(e){return e.metamask.userUniqueId}function ke(e,t){let{createdMap:r}=e.metamask;return r[t]}function Oe(e,t){let{addedCoins:r}=e.metamask;return r[t]||[]}function Ue(e,t){let{reducedCoins:r}=e.metamask;return r[t]||[]}async function Ne(){return E().getCustomCoins()}async function Pe(e,t){return E().setAllCoins(e,t)}function ve(e,t,r=null){return async(s,n)=>{let o=n(),a=C(o),i=await E().getRequestHeaders({walletId:a,needSign:!0,currency:O(o)}),c=U(o);try{let l;r?.channel&&(l=await Te({...r,walletId:a,account:T(o,a)}));let{data:m={}}=l||await M(B.newGetAllAssetsUrl,{userUniqueId:c,accountIds:e,combinationCoins:!0,chainIndexes:t?[t]:void 0},{headers:i,needSign:!0}),g=m.coins??[],f=m.assets??[],A=new Map(g.map(R=>[R.coinId,oe(R)]));_e({data:{coins:g,assets:f.filter(R=>R.walletId===a)}});let h=await ue(le.coinTickers);return{assets:be(f,A,h),coinsMap:A}}catch(l){return Ie(l)}}}function N(e){return async t=>{let r={};e.forEach(s=>{r[s.walletId]=s});try{t(Ee(r)),await fe(e)}catch{Y()}}}u();d();Ze();se();u();d();W();se();Qe();u();d();Xe();function De(e,t){let r=[];return e.reduce((s,n)=>n.childrenCoin?s.concat(...n.childrenCoin):s.concat(n),[]).forEach(s=>{t&&ae.includes(s.coinId)&&r.push(s)}),r}async function Ve(e,t,r={}){let{needSetDefault:s}=r,n=De(e,s);n.length?E().updateWalletAddress(t,n.reduce((o,{coinId:a,userAddress:i})=>{let c=re({coinId:+a})?.localType,l=te(c);return Object.entries(r.accountsMap[l]).forEach(([m,g])=>{g.address===i&&(o[l]=m)}),o},{}),{needUpdateBalance:!1,needUpdateSegwitAddressType:!0,needSync:!0,needEmitChangeAddress:!1}):s&&E().updateWalletAddress(t,{},{needUpdateBalance:!1,needUpdateSegwitAddressType:!0,needSync:!0,needEmitChangeAddress:!1})}function Le({walletData:e,coinsMap:t}){return(r,s)=>{let n=s(),o=e.walletId,a=ke(n,o),c=T(n,o)?.initialType===ie.SIMPLE_KEYRING,l=Oe(n,o),m=Ue(n,o);return z({isReady:!0,defaultBaseCoinsCoinIds:c?a.map(g=>g.coinId):[],addedCoins:l,reducedCoins:m,balanceCoins:Re({balanceCoins:e.coins,coinsMap:t,flatten:!1}),defi:e.defi,nft:e.nft,hiddenSmallAssets:!0,networks:ne()})}}function Ke({coinsMap:e,walletData:t}){return async(r,s)=>{let n=s(),o=T(n,t.walletId);Ve(t.coins,t.walletId,o);let a=await Ne();C(n)===t.walletId&&(Pe(Array.from(e.values()),a),r(N([t])))}}var qe=50,P=!1;function Fe({walletIds:e,chainId:t,pushData:r}){return async(s,n)=>{let o=n(),a=[],i=!t;return await Promise.all(L(e,qe).map(async c=>{let{assets:l,coinsMap:m}=await s(ve(c,t,r)),g=[];l.forEach(f=>{let{walletId:A}=f;if(i){let h=s(Le({walletData:f,coinsMap:m}));h&&g.push({walletId:A,...h});let v=C(o);A===v&&s(Ke({coinsMap:m,walletData:f}))}a.push({walletId:A,coins:Array.from(m.values()),balanceData:f})}),i&&q(g)})),a}}function je(e){return async(t,r)=>{let s=r(),n=C(s);if(!(!n||!Be(s,n))){try{await t(Fe({walletIds:[n],pushData:e}))}catch(a){let i=await ge(n);throw await t(N([{...i??{},walletId:n,error:!0,v:2}])),a}if(me()){de();let a=setTimeout(()=>{t(je()),clearTimeout(a)},2e3)}}}}function Qn(e){return async(t,r)=>{let s=r();C(s)===e&&await t(je())}}function Xn({walletIds:e,chainId:t,coinId:r}){return async s=>{let n=await s(Fe({walletIds:e,chainId:t}));return n?.length?n.map(o=>We(o,r)):null}}function Zn(){return async(e,t)=>{if(P)return;let r=t();P=!0;let s=Me(r),n=C(r),o=await E().getRequestHeaders({walletId:n,needSign:!0,currency:O(r)}),a=U(r);try{await Promise.all(L(s,qe).map(async i=>{let{data:c={}}=await M(B.getWalletManageAsset,{userUniqueId:a,accountIds:i},{headers:o,needSign:!0}),l=r.metamask.preferences.showNftAmount,m=c.map(g=>Q(g,l));q(m)})),P=!1}catch(i){throw P=!1,F[i?.message]?new Error(i?.message):new Error(i)}}}export{F as a,Ie as b,pt as c,ht as d,St as e,Fe as f,je as g,Qn as h,Xn as i,Zn as j};

window.inOKXExtension = true;
window.inMiniApp = false;
window.ASSETS_BUILD_TYPE = "publish";

//# sourceMappingURL=chunk-F7VSWGDW.js.map
